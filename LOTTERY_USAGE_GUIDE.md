# 抽奖功能使用指南

## 完整流程说明

### 1️⃣ 创建抽奖

**步骤：**

1. **在群组中发起创建**
   ```
   /create_lottery
   ```
   - 必须在群组中使用
   - 只有已绑定的 Bot 管理员可以创建

2. **Bot 会私聊你，开始创建流程**
   
   **第一步：输入活动名称**
   - Bot 发送："📝 请输入活动名称"
   - 你有 120 秒时间输入
   - 示例：`新年抽奖活动`

   **第二步：设置奖品（交互式）**
   - Bot 发送："📝 请发送第一个奖品的名称"
   - 你输入：`一等奖`
   - Bot 发送："🔢 请发送该奖品的数量"
   - 你输入：`1`
   - Bot 显示当前奖品列表
   - 继续添加：发送下一个奖品名称
   - 完成设置：发送 `/next`
   
   示例流程：
   ```
   你: 一等奖
   Bot: 请发送数量
   你: 1
   Bot: 已添加，继续添加或发送 /next
   你: 二等奖
   Bot: 请发送数量
   你: 2
   Bot: 已添加，继续添加或发送 /next
   你: /next
   Bot: 奖品设置完成
   ```

   **第三步：输入参与关键词**
   - Bot 发送："🔑 请输入参与关键词"
   - 你有 120 秒时间输入
   - 示例：`参与抽奖`
   - 用户需要在群组中发送这个关键词来参与

   **第四步：选择开奖时间**
   - Bot 发送："⏰ 请选择开奖时间"
   - 提供三个按钮：
     - `1 小时`
     - `1 天`
     - `3 天`
   - 你有 120 秒时间选择

3. **创建完成**
   - Bot 在群组中发送抽奖消息
   - 显示活动名称、参与关键词、开奖时间等信息

**注意事项：**
- 任何步骤超时 120 秒会自动取消
- 可以随时发送 `/cancel` 取消创建
- 创建前需要先在 Bot 私聊中发送 `/start`

### 2️⃣ 用户参与抽奖

**参与方式：**

1. 在群组中发送关键词
   ```
   参与抽奖
   ```

2. Bot 会：
   - 记录参与者
   - 更新群组消息的参与人数
   - 私聊通知参与成功

**参与成功通知（私聊）：**
```
✅ 参与成功！

🎊 活动：新年抽奖活动
⏰ 开奖时间：2024/1/1 12:00:00

祝你好运！🍀
```

**限制：**
- 每人只能参与一次
- 重复参与会收到提示

### 3️⃣ 管理抽奖

**查看所有抽奖：**

在 Bot 私聊中发送：
```
/viewlottery
```

Bot 会显示所有进行中的抽奖活动列表，点击可以查看详情。

**抽奖详情界面：**
```
🎊 新年抽奖活动

📍 群组：测试群组
🔑 关键词：参与抽奖
👥 参与人数：25
⏰ 计划开奖：2024/1/1 12:00:00
⏱️ 剩余时间：2小时30分钟
📊 状态：进行中
```

**管理操作：**
- ⏰ 延迟 1 小时
- ⏰ 延迟 1 天
- 🏁 立即结束
- « 返回列表

### 4️⃣ 自动开奖

**到达开奖时间后：**

1. Bot 自动执行开奖
2. 随机抽取中奖者
3. 更新群组消息显示结果
4. 私聊通知所有中奖者

**中奖通知（私聊）：**
```
🎉 恭喜中奖！

🎊 活动：新年抽奖活动
🏆 你在抽奖中获胜了！

请联系活动发起人领取奖品。
```

**群组结果展示：**
```
🎊 新年抽奖活动 (已结束)

🔑 参与关键词：参与抽奖
⏰ 开奖时间：2024/1/1 12:00:00
🏁 实际结束：2024/1/1 12:00:05

总参与人数：25

🎉 中奖名单：

一等奖：
🏆 张三 @zhangsan

二等奖：
🏆 李四 @lisi
🏆 王五 @wangwu

三等奖：
🏆 赵六 @zhaoliu
🏆 孙七 @sunqi
🏆 周八 @zhouba
🏆 吴九 @wujiu
🏆 郑十 @zhengshi
```

### 5️⃣ 提前结束抽奖

**操作步骤：**

1. 发送 `/viewlottery`
2. 选择要结束的抽奖
3. 点击 `🏁 立即结束`
4. Bot 立即执行开奖并公布结果

### 6️⃣ 延迟开奖

**操作步骤：**

1. 发送 `/viewlottery`
2. 选择要延迟的抽奖
3. 点击 `⏰ 延迟 1 小时` 或 `⏰ 延迟 1 天`
4. 开奖时间自动延后
5. 群组消息更新显示新的开奖时间

## 命令列表

| 命令 | 使用位置 | 权限 | 说明 |
|------|---------|------|------|
| `/create_lottery` | 群组 | Bot 管理员 | 创建抽奖活动 |
| `/viewlottery` | 私聊 | Bot 管理员 | 查看和管理抽奖 |
| `/next` | 私聊 | 任何人 | 完成奖品设置，进入下一步 |
| `/cancel` | 私聊 | 任何人 | 取消创建流程 |

## 技术特性

✅ **状态机管理**
- 三步创建流程
- 每步 120 秒超时
- 自动清理过期会话

✅ **定时任务**
- 自动开奖
- 服务器重启后自动恢复
- 支持延迟和提前结束

✅ **私聊通知**
- 参与成功通知
- 中奖通知
- 需要用户先 `/start` bot

✅ **数据持久化**
- 所有抽奖记录保存在数据库
- 参与者信息完整记录
- 支持 WebUI 查看

✅ **公平性保证**
- 随机算法抽取
- 防止重复参与
- 透明的中奖名单

## 常见问题

**Q: 创建抽奖时 Bot 没有私聊我？**
A: 需要先在 Bot 私聊中发送 `/start` 命令。

**Q: 超时了怎么办？**
A: 重新在群组中使用 `/create_lottery` 命令。

**Q: 可以修改已创建的抽奖吗？**
A: 可以延迟开奖时间或提前结束，但不能修改标题和关键词。

**Q: 服务器重启后抽奖还会自动开奖吗？**
A: 会的，系统会自动恢复所有待开奖的定时任务。

**Q: 用户没收到参与成功通知？**
A: 用户需要先在 Bot 私聊中发送 `/start` 才能收到私聊消息。

**Q: 可以创建多个抽奖吗？**
A: 可以，每个群组可以同时有多个进行中的抽奖。

## WebUI 查看

在 WebUI 的群组页面可以看到：
- 所有抽奖活动列表
- 抽奖状态（进行中/已结束）
- 参与人数和中奖人数
- 创建时间

## 示例场景

### 场景 1：快速抽奖（1小时）

1. 群组中：`/create_lottery`
2. 私聊输入：`限时抽奖`
3. 私聊输入：`中奖`
4. 私聊输入：`5`
5. 私聊输入：`/next`
6. 私聊输入：`GO`
7. 点击：`1 小时`
8. 群组中通知用户发送 `GO` 参与
9. 1小时后自动开奖

### 场景 2：多级奖品（3天）

1. 群组中：`/create_lottery`
2. 私聊输入：`周年庆抽奖`
3. 添加奖品：
   - 输入：`特等奖` → `1`
   - 输入：`一等奖` → `3`
   - 输入：`二等奖` → `10`
   - 输入：`三等奖` → `20`
   - 输入：`/next`
4. 私聊输入：`周年快乐`
5. 点击：`3 天`
6. 3天内用户随时可以参与
7. 3天后自动开奖，按奖品等级分配

### 场景 3：提前结束

1. 参与人数已经很多
2. 私聊：`/viewlottery`
3. 选择抽奖
4. 点击：`🏁 立即结束`
5. 立即开奖并公布结果

这就是完整的抽奖功能使用指南！
