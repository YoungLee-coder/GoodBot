# GoodBot 实施计划

- [x] 1. 初始化项目结构和依赖





  - 使用 pnpm 创建 Next.js 15 项目
  - 安装核心依赖: React 19, TypeScript, Tailwind CSS 4, Prisma, grammy, NextAuth.js v5
  - 配置 TypeScript 和 ESLint
  - 设置 Tailwind CSS 4 配置
  - 初始化 shadcn/ui
  - _需求: 8.1, 8.2, 8.3_

- [x] 2. 配置数据库和 Prisma





  - 创建 Prisma schema 定义数据模型（BotConfig, Message, Group, User）
  - 配置 Neon PostgreSQL 连接
  - 生成 Prisma Client
  - 创建初始数据库迁移
  - _需求: 7.1_

- [ ]* 2.1 编写属性测试验证数据库连接
  - **属性 23: 数据库连接失败处理**
  - **验证需求: 7.2**

- [x] 3. 实现 Bot 配置服务





  - 创建 BotConfigService 类处理 Token 验证和存储
  - 实现 Telegram Bot API 客户端初始化（使用 grammy）
  - 实现 getBotInfo 方法获取 Bot 信息
  - 实现 setupWebhook 和 deleteWebhook 方法
  - _需求: 1.2, 1.4_

- [ ]* 3.1 编写属性测试验证 Bot Token 处理
  - **属性 1: Bot Token 验证和存储**
  - **验证需求: 1.2**

- [ ]* 3.2 编写属性测试验证无效 Token 拒绝
  - **属性 2: 无效 Token 拒绝**
  - **验证需求: 1.3**

- [ ]* 3.3 编写属性测试验证 Webhook 自动设置
  - **属性 3: Webhook 自动设置**
  - **验证需求: 1.4**

- [x] 4. 实现认证系统





  - 配置 NextAuth.js v5 (Auth.js)
  - 创建 Credentials Provider 支持邮箱密码登录
  - 实现密码哈希（使用 bcrypt）
  - 创建认证中间件保护管理路由
  - 实现会话管理和超时配置
  - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ]* 4.1 编写属性测试验证认证流程
  - **属性 19: 未认证访问重定向**
  - **验证需求: 6.1**

- [ ]* 4.2 编写属性测试验证会话创建
  - **属性 20: 认证成功会话创建**
  - **验证需求: 6.2**

- [ ]* 4.3 编写属性测试验证认证失败处理
  - **属性 21: 认证失败访问拒绝**
  - **验证需求: 6.4**

- [x] 5. 创建 Webhook 处理器





  - 实现 /api/webhook POST 路由
  - 解析 Telegram Update 对象
  - 验证 Webhook 请求来源（使用 secret token）
  - 区分消息类型（私聊、群组、Bot 加入群组等）
  - 调用相应的服务层方法处理消息
  - _需求: 2.1, 4.1, 5.1_

- [ ]* 5.1 编写属性测试验证消息接收和存储
  - **属性 5: 消息接收和完整存储**
  - **验证需求: 2.1, 2.2**

- [ ]* 5.2 编写属性测试验证群组加入检测
  - **属性 12: 群组加入自动存储**
  - **验证需求: 4.1**

- [x] 6. 实现消息服务





  - 创建 MessageService 类
  - 实现 saveIncomingMessage 方法存储接收的消息
  - 实现 getMessages 方法支持分页和过滤
  - 实现 getConversation 方法获取特定对话
  - 实现 sendMessage 方法通过 Telegram API 发送消息
  - 确保使用数据库事务保证数据完整性
  - _需求: 2.1, 2.2, 2.3, 3.2, 3.3, 7.3_

- [ ]* 6.1 编写属性测试验证消息列表排序
  - **属性 6: 消息列表时间倒序**
  - **验证需求: 2.3**

- [ ]* 6.2 编写属性测试验证对话历史排序
  - **属性 11: 对话历史时间排序**
  - **验证需求: 3.5**

- [ ]* 6.3 编写属性测试验证消息发送和存储
  - **属性 9: 消息发送和存储**
  - **验证需求: 3.2, 3.3**

- [ ]* 6.4 编写属性测试验证数据事务性
  - **属性 24: 数据存储事务性**
  - **验证需求: 7.3**

- [x] 7. 实现群组服务




  - 创建 GroupService 类
  - 实现 saveGroup 方法存储群组信息
  - 实现 getGroups 方法获取群组列表
  - 实现 getGroupDetails 方法获取群组详情
  - 实现 leaveGroup 方法退出群组并更新数据库
  - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_

- [ ]* 7.1 编写属性测试验证群组列表完整性
  - **属性 13: 群组列表完整性**
  - **验证需求: 4.2, 4.3**

- [ ]* 7.2 编写属性测试验证群组退出同步
  - **属性 15: 群组退出同步更新**
  - **验证需求: 4.5**

- [x] 8. 创建 Bot 配置 API 路由





  - 实现 POST /api/bot/config 保存 Bot 配置
  - 实现 GET /api/bot/info 获取 Bot 信息
  - 实现 POST /api/bot/webhook 设置 Webhook
  - 添加请求验证和错误处理
  - _需求: 1.2, 1.3, 1.4, 1.5_

- [ ]* 8.1 编写属性测试验证配置信息完整性
  - **属性 4: 配置信息完整性**
  - **验证需求: 1.5**

- [x] 9. 创建消息管理 API 路由





  - 实现 GET /api/messages 获取消息列表（支持分页）
  - 实现 GET /api/messages/[chatId] 获取特定对话
  - 实现 POST /api/messages/send 发送消息
  - 添加错误处理和重试逻辑
  - _需求: 2.3, 2.4, 3.2, 3.3, 3.4_

- [ ]* 9.1 编写单元测试验证分页功能
  - 测试超过 50 条消息时的分页行为
  - _需求: 2.4_

- [ ]* 9.2 编写属性测试验证发送失败处理
  - **属性 10: 发送失败错误处理**
  - **验证需求: 3.4**

- [x] 10. 创建群组管理 API 路由





  - 实现 GET /api/groups 获取群组列表
  - 实现 GET /api/groups/[id] 获取群组详情
  - 实现 POST /api/groups/[id]/leave 退出群组
  - 实现 GET /api/groups/[id]/messages 获取群组消息
  - _需求: 4.2, 4.3, 4.4, 4.5, 5.3_

- [ ]* 10.1 编写属性测试验证群组消息查询
  - **属性 17: 群组消息查询过滤**
  - **验证需求: 5.3**

- [ ]* 10.2 编写属性测试验证群组消息发送
  - **属性 18: 群组消息发送和显示**
  - **验证需求: 5.4, 5.5**

- [x] 11. 创建登录和认证 UI 页面





  - 创建 /login 登录页面
  - 使用 shadcn/ui 组件构建表单
  - 实现登录表单验证
  - 实现登出功能
  - 添加会话超时提示
  - _需求: 6.1, 6.2, 6.4, 6.5_

- [ ]* 11.1 编写属性测试验证登出功能
  - **属性 22: 登出会话清除**
  - **验证需求: 6.5**

- [x] 12. 创建 Bot 配置管理 UI





  - 创建 /dashboard/config 配置页面
  - 实现 Bot Token 输入表单
  - 显示 Bot 信息（用户名、状态）
  - 显示 Webhook 状态
  - 实现配置保存和验证反馈
  - _需求: 1.1, 1.2, 1.3, 1.5_

- [x] 13. 创建消息列表和对话 UI





  - 创建 /dashboard/messages 消息列表页面
  - 实现消息列表展示（时间倒序）
  - 实现分页控件
  - 创建 /dashboard/messages/[chatId] 对话详情页面
  - 实现消息详情展示（发送者头像、用户名、内容、时间）
  - 实现回复输入框和发送功能
  - 显示发送状态和错误提示
  - _需求: 2.3, 2.4, 2.5, 3.1, 3.2, 3.3, 3.4, 3.5_

- [ ]* 13.1 编写属性测试验证消息详情完整性
  - **属性 7: 消息详情完整性**
  - **验证需求: 2.5**

- [ ]* 13.2 编写属性测试验证回复 UI 状态
  - **属性 8: 回复 UI 状态更新**
  - **验证需求: 3.1**
-

- [x] 14. 创建群组管理 UI




  - 创建 /dashboard/groups 群组列表页面
  - 显示群组列表（名称、成员数、加入时间、状态）
  - 创建 /dashboard/groups/[id] 群组详情页面
  - 显示群组消息历史
  - 实现群组消息发送功能
  - 实现退出群组功能和确认对话框
  - _需求: 4.2, 4.3, 4.4, 4.5, 5.3, 5.4, 5.5_

- [x] 15. 创建仪表板概览页面





  - 创建 /dashboard 主页
  - 显示关键指标（消息总数、群组数量、今日消息）
  - 显示最近消息列表
  - 显示 Bot 状态
  - _需求: 1.5_
-

- [x] 16. 实现错误处理和用户反馈




  - 创建统一的错误响应格式
  - 实现 API 错误处理中间件
  - 创建 Toast 通知组件显示操作结果
  - 实现加载状态指示器
  - 添加错误边界组件
  - _需求: 1.3, 3.4, 7.2, 7.5_

- [ ]* 16.1 编写属性测试验证数据库错误处理
  - **属性 25: 数据库错误优雅处理**
  - **验证需求: 7.5**
-

- [x] 17. 配置环境变量和部署设置




  - 创建 .env.example 文件
  - 配置 Vercel 环境变量
  - 设置 Vercel 构建命令包含 Prisma 生成
  - 配置生产环境数据库迁移
  - _需求: 8.5_

- [ ]* 17.1 编写属性测试验证环境变量读取
  - **属性 26: 环境变量配置读取**
  - **验证需求: 8.5**

- [x] 18. 添加数据库索引和优化





  - 在 Message 表的 chatId 和 createdAt 上创建复合索引
  - 在 Group 表的 isActive 上创建索引
  - 实现游标分页优化大数据集查询
  - _需求: 7.4_

- [x] 19. 实现安全措施





  - 添加 Webhook secret token 验证
  - 实现 API 速率限制
  - 配置 CSRF 保护
  - 验证所有用户输入
  - _需求: 6.1, 6.2, 6.3_

- [x] 20. 检查点 - 确保所有测试通过





  - 确保所有测试通过，如有问题请询问用户

- [x] 21. 编写部署文档





  - 创建 README.md 包含项目说明
  - 编写部署步骤文档
  - 记录环境变量配置
  - 添加本地开发指南
  - _需求: 8.1, 8.2, 8.3_

- [x] 22. 最终检查点 - 系统集成测试





  - 确保所有测试通过，如有问题请询问用户
